name: Build and Deploy MCP Server to Alibaba Cloud

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
        
    - name: è¿è¡Œ Maven æ„å»º
      run: mvn clean package -DskipTests
      
    - name: è¿è¡Œæµ‹è¯•
      run: mvn test
      
    - name: éªŒè¯æ„å»ºäº§ç‰©
      run: ls -la target/
        
    - name: è®¾ç½® Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ç™»å½•é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡
      uses: docker/login-action@v3
      with:
        registry: ${{ secrets.ALIBABA_CLOUD_REGISTRY }}
        username: ${{ secrets.ALIBABA_CLOUD_USERNAME }}
        password: ${{ secrets.ALIBABA_CLOUD_PASSWORD }}
        
    - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
      id: version
      run: |
        VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
        SHORT_SHA=$(git rev-parse --short HEAD)
        IMAGE_TAG=${VERSION}-${SHORT_SHA}
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
        echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
        
    - name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: |
          ${{ secrets.ALIBABA_CLOUD_REGISTRY }}/${{ secrets.ALIBABA_CLOUD_NAMESPACE }}/bhuang-mcp-server-sse:latest
          ${{ secrets.ALIBABA_CLOUD_REGISTRY }}/${{ secrets.ALIBABA_CLOUD_NAMESPACE }}/bhuang-mcp-server-sse:${{ steps.version.outputs.image_tag }}
        platforms: linux/amd64
        
    - name: æ˜¾ç¤ºé•œåƒä¿¡æ¯
      run: |
        echo "âœ… MCP Serveré•œåƒæ„å»ºå¹¶æ¨é€æˆåŠŸï¼"
        echo "ğŸ“¦ é•œåƒæ ‡ç­¾ï¼š"
        echo "   - ${{ secrets.ALIBABA_CLOUD_REGISTRY }}/${{ secrets.ALIBABA_CLOUD_NAMESPACE }}/bhuang-mcp-server-sse:latest"
        echo "   - ${{ secrets.ALIBABA_CLOUD_REGISTRY }}/${{ secrets.ALIBABA_CLOUD_NAMESPACE }}/bhuang-mcp-server-sse:${{ steps.version.outputs.image_tag }}"
        
    - name: ğŸ“‹ MCP Server ä½¿ç”¨è¯´æ˜
      run: |
        echo ""
        echo "ğŸš€ ================== MCP Server é•œåƒä½¿ç”¨æŒ‡å— =================="
        echo ""
        echo "ğŸ“ 1. ç™»å½•é˜¿é‡Œäº‘Docker Registryï¼š"
        echo "   docker login --username=é»„å¸…å•Š ${{ secrets.ALIBABA_CLOUD_REGISTRY }}"
        echo ""
        echo "ğŸ“¦ 2. æ‹‰å–é•œåƒï¼ˆé€‰æ‹©å…¶ä¸€ï¼‰ï¼š"
        echo "   # æ‹‰å–æœ€æ–°ç‰ˆæœ¬"
        echo "   docker pull ${{ secrets.ALIBABA_CLOUD_REGISTRY }}/${{ secrets.ALIBABA_CLOUD_NAMESPACE }}/bhuang-mcp-server-sse:latest"
        echo ""
        echo "   # æ‹‰å–æŒ‡å®šç‰ˆæœ¬"
        echo "   docker pull ${{ secrets.ALIBABA_CLOUD_REGISTRY }}/${{ secrets.ALIBABA_CLOUD_NAMESPACE }}/bhuang-mcp-server-sse:${{ steps.version.outputs.image_tag }}"
        echo ""
        echo "ğŸƒ 3. è¿è¡ŒMCP Serverå®¹å™¨ï¼š"
        echo "   # åŸºæœ¬è¿è¡Œï¼ˆSSEç«¯ç‚¹: 8080ç«¯å£ï¼‰"
        echo "   docker run -d --name bhuang-mcp-server -p 8080:8080 \\"
        echo "     ${{ secrets.ALIBABA_CLOUD_REGISTRY }}/${{ secrets.ALIBABA_CLOUD_NAMESPACE }}/bhuang-mcp-server-sse:latest"
        echo ""
        echo "   # ç”Ÿäº§ç¯å¢ƒè¿è¡Œ"
        echo "   docker run -d --name bhuang-mcp-server -p 8080:8080 \\"
        echo "     -e JAVA_OPTS=\"-Xms512m -Xmx1024m -Dspring.profiles.active=prod\" \\"
        echo "     -e TZ=\"Asia/Shanghai\" \\"
        echo "     --restart unless-stopped \\"
        echo "     -v /data/logs:/app/logs \\"
        echo "     ${{ secrets.ALIBABA_CLOUD_REGISTRY }}/${{ secrets.ALIBABA_CLOUD_NAMESPACE }}/bhuang-mcp-server-sse:latest"
        echo ""
        echo "ğŸ³ 4. ä½¿ç”¨ Docker Composeï¼š"
        echo "   # ä¸‹è½½ docker-compose.yml æ–‡ä»¶"
        echo "   curl -O https://raw.githubusercontent.com/${{ github.repository }}/master/docker-compose.yml"
        echo "   # å¯åŠ¨æœåŠ¡"
        echo "   docker-compose up -d"
        echo ""
        echo "ğŸ“Š 5. MCP Server ç›‘æ§å’Œç»´æŠ¤ï¼š"
        echo "   # æŸ¥çœ‹è¿è¡ŒçŠ¶æ€"
        echo "   docker ps | grep bhuang-mcp-server"
        echo "   # æŸ¥çœ‹å®æ—¶æ—¥å¿—"
        echo "   docker logs -f bhuang-mcp-server"
        echo "   # Spring Bootå¥åº·æ£€æŸ¥"
        echo "   curl http://localhost:8080/actuator/health"
        echo "   # MCP ServerçŠ¶æ€æ£€æŸ¥"
        echo "   curl http://localhost:8080/actuator/info"
        echo ""
        echo "ğŸ”§ 6. MCP å®¢æˆ·ç«¯è¿æ¥ï¼š"
        echo "   # SSEç«¯ç‚¹è¿æ¥"
        echo "   curl -N -H \"Accept: text/event-stream\" http://localhost:8080/sse"
        echo "   # æ¶ˆæ¯ç«¯ç‚¹ï¼ˆéœ€è¦å…ˆå»ºç«‹SSEè¿æ¥è·å–sessionIdï¼‰"
        echo "   curl -X POST http://localhost:8080/mcp/messages?sessionId=YOUR_SESSION_ID \\"
        echo "     -H \"Content-Type: application/json\" \\"
        echo "     -d '{\"jsonrpc\":\"2.0\",\"id\":1,\"method\":\"tools/list\"}'"
        echo ""
        echo "ğŸ› ï¸ 7. ä¸€é”®éƒ¨ç½²è„šæœ¬ï¼š"
        echo "   # ä¸‹è½½éƒ¨ç½²è„šæœ¬"
        echo "   curl -O https://raw.githubusercontent.com/${{ github.repository }}/master/deploy.sh"
        echo "   chmod +x deploy.sh"
        echo "   # æ‰§è¡Œéƒ¨ç½²"
        echo "   ./deploy.sh"
        echo ""
        echo "ğŸ“š 8. MCPåè®®æ–‡æ¡£ï¼š"
        echo "   # Model Context Protocolè§„èŒƒ"
        echo "   echo \"https://spec.modelcontextprotocol.io/\""
        echo "   # æœ¬é¡¹ç›®APIæ–‡æ¡£"
        echo "   echo \"http://localhost:8080/swagger-ui.html\""
        echo ""
        echo "=================================================="
        echo "âœ¨ ç‰ˆæœ¬ä¿¡æ¯ï¼š"
        echo "   åº”ç”¨ç‰ˆæœ¬: ${{ steps.version.outputs.version }}"
        echo "   Gitæäº¤: ${{ steps.version.outputs.short_sha }}"
        echo "   é•œåƒæ ‡ç­¾: ${{ steps.version.outputs.image_tag }}"
        echo "   æ„å»ºæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "   MCPåè®®ç‰ˆæœ¬: 2024-11-05"
        echo "=================================================="
        
    - name: ğŸ“ åˆ›å»ºMCP Serveréƒ¨ç½²æ€»ç»“
      if: github.event_name == 'push'
      uses: actions/github-script@v7
      with:
        script: |
          const summary = `
          ## ğŸš€ MCP Server éƒ¨ç½²æˆåŠŸï¼
          
          ### ğŸ“¦ é•œåƒä¿¡æ¯
          - **é¡¹ç›®åç§°**: Bhuang MCP Server with SSE Transport
          - **æœ€æ–°ç‰ˆæœ¬**: \`${{ secrets.ALIBABA_CLOUD_REGISTRY }}/${{ secrets.ALIBABA_CLOUD_NAMESPACE }}/bhuang-mcp-server-sse:latest\`
          - **æŒ‡å®šç‰ˆæœ¬**: \`${{ secrets.ALIBABA_CLOUD_REGISTRY }}/${{ secrets.ALIBABA_CLOUD_NAMESPACE }}/bhuang-mcp-server-sse:${{ steps.version.outputs.image_tag }}\`
          
          ### ğŸƒ å¿«é€Ÿå¼€å§‹
          
          #### æ–¹å¼1: ç›´æ¥è¿è¡Œ
          \`\`\`bash
          # ç™»å½•é˜¿é‡Œäº‘
          docker login --username=é»„å¸…å•Š ${{ secrets.ALIBABA_CLOUD_REGISTRY }}
          
          # æ‹‰å–å¹¶è¿è¡ŒMCP Server
          docker pull ${{ secrets.ALIBABA_CLOUD_REGISTRY }}/${{ secrets.ALIBABA_CLOUD_NAMESPACE }}/bhuang-mcp-server-sse:latest
          docker run -d --name bhuang-mcp-server -p 8080:8080 \\
            -e JAVA_OPTS="-Xms512m -Xmx1024m" \\
            -e TZ="Asia/Shanghai" \\
            --restart unless-stopped \\
            ${{ secrets.ALIBABA_CLOUD_REGISTRY }}/${{ secrets.ALIBABA_CLOUD_NAMESPACE }}/bhuang-mcp-server-sse:latest
          \`\`\`
          
          #### æ–¹å¼2: Docker Compose
          \`\`\`bash
          curl -O https://raw.githubusercontent.com/${{ github.repository }}/master/docker-compose.yml
          docker-compose up -d
          \`\`\`
          
          #### æ–¹å¼3: ä¸€é”®éƒ¨ç½²
          \`\`\`bash
          curl -O https://raw.githubusercontent.com/${{ github.repository }}/master/deploy.sh
          chmod +x deploy.sh && ./deploy.sh
          \`\`\`
          
          ### ğŸ”§ MCP å®¢æˆ·ç«¯è¿æ¥
          
          #### 1. å»ºç«‹SSEè¿æ¥
          \`\`\`bash
          # è·å–ä¼šè¯ID
          curl -N -H "Accept: text/event-stream" http://localhost:8080/sse
          \`\`\`
          
          #### 2. å‘é€MCPæ¶ˆæ¯
          \`\`\`bash
          # åˆå§‹åŒ–è¯·æ±‚
          curl -X POST "http://localhost:8080/mcp/messages?sessionId=YOUR_SESSION_ID" \\
            -H "Content-Type: application/json" \\
            -d '{
              "jsonrpc": "2.0",
              "id": 1,
              "method": "initialize",
              "params": {
                "protocolVersion": "2024-11-05",
                "capabilities": {"tools": {}},
                "clientInfo": {"name": "test-client", "version": "1.0.0"}
              }
            }'
          
          # è·å–å·¥å…·åˆ—è¡¨
          curl -X POST "http://localhost:8080/mcp/messages?sessionId=YOUR_SESSION_ID" \\
            -H "Content-Type: application/json" \\
            -d '{"jsonrpc": "2.0", "id": 2, "method": "tools/list"}'
          \`\`\`
          
          ### âœ¨ ç‰ˆæœ¬è¯¦æƒ…
          - **åº”ç”¨ç‰ˆæœ¬**: ${{ steps.version.outputs.version }}
          - **Gitæäº¤**: ${{ steps.version.outputs.short_sha }}
          - **MCPåè®®ç‰ˆæœ¬**: 2024-11-05
          - **æ„å»ºæ—¶é—´**: ${new Date().toISOString()}
          
          ### ğŸ“Š æœåŠ¡ç«¯ç‚¹
          - **SSEç«¯ç‚¹**: http://localhost:8080/sse
          - **æ¶ˆæ¯ç«¯ç‚¹**: http://localhost:8080/mcp/messages
          - **å¥åº·æ£€æŸ¥**: http://localhost:8080/actuator/health
          - **åº”ç”¨ä¿¡æ¯**: http://localhost:8080/actuator/info
          - **APIæ–‡æ¡£**: http://localhost:8080/swagger-ui.html
          
          ### ğŸ› ï¸ ç›‘æ§å‘½ä»¤
          \`\`\`bash
          # æŸ¥çœ‹è¿è¡ŒçŠ¶æ€
          docker ps | grep bhuang-mcp-server
          
          # æŸ¥çœ‹æ—¥å¿—
          docker logs -f bhuang-mcp-server
          
          # å¥åº·æ£€æŸ¥
          curl http://localhost:8080/actuator/health
          
          # æµ‹è¯•SSEè¿æ¥
          curl -N -H "Accept: text/event-stream" http://localhost:8080/sse
          \`\`\`
          
          ### ğŸ”— ç›¸å…³é“¾æ¥
          - [Model Context Protocol è§„èŒƒ](https://spec.modelcontextprotocol.io/)
          - [Spring AI MCP æ–‡æ¡£](https://docs.spring.io/spring-ai/reference/api/mcp.html)
          - [é¡¹ç›®æºç ](https://github.com/${{ github.repository }})
          `;
          
          await core.summary.addRaw(summary).write(); 