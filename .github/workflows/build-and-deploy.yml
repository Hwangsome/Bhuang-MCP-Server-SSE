name: Build and Deploy to Alibaba Cloud

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  # é˜¿é‡Œäº‘é•œåƒä»“åº“é…ç½®
  ALIBABA_CLOUD_REGISTRY: crpi-wzl2k45d0lxbiagj.cn-shenzhen.personal.cr.aliyuncs.com
  ALIBABA_CLOUD_NAMESPACE: bhuang-repo
  IMAGE_NAME: bhuang-mcp-server-sse

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸš€ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: â˜• è®¾ç½® JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: ğŸ”§ è¿è¡Œ Maven æ„å»º
        run: mvn clean package -DskipTests

      - name: ğŸ§ª è¿è¡Œæµ‹è¯•
        run: mvn test

      - name: ğŸ“¦ éªŒè¯æ„å»ºäº§ç‰©
        run: |
          echo "ğŸ“‹ æ„å»ºäº§ç‰©åˆ—è¡¨ï¼š"
          ls -la target/
          echo ""
          echo "âœ… JAR æ–‡ä»¶ä¿¡æ¯ï¼š"
          ls -lh target/*.jar

      - name: ğŸ³ è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” ç™»å½•é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ALIBABA_CLOUD_REGISTRY }}
          username: ${{ secrets.ALIBABA_CLOUD_USERNAME }}
          password: ${{ secrets.ALIBABA_CLOUD_PASSWORD }}

      - name: ğŸ“ è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          SHORT_SHA=$(git rev-parse --short HEAD)
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          IMAGE_TAG_VERSION=${VERSION}-${SHORT_SHA}
          IMAGE_TAG_TIMESTAMP=v${TIMESTAMP}-${SHORT_SHA}
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "image_tag_version=${IMAGE_TAG_VERSION}" >> $GITHUB_OUTPUT
          echo "image_tag_timestamp=${IMAGE_TAG_TIMESTAMP}" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š ç‰ˆæœ¬ä¿¡æ¯ï¼š"
          echo "  åº”ç”¨ç‰ˆæœ¬: ${VERSION}"
          echo "  Gitæäº¤: ${SHORT_SHA}"
          echo "  æ—¶é—´æˆ³: ${TIMESTAMP}"
          echo "  é•œåƒæ ‡ç­¾: ${IMAGE_TAG_VERSION}, ${IMAGE_TAG_TIMESTAMP}"

      - name: ğŸ—ï¸ æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.ALIBABA_CLOUD_REGISTRY }}/${{ env.ALIBABA_CLOUD_NAMESPACE }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.ALIBABA_CLOUD_REGISTRY }}/${{ env.ALIBABA_CLOUD_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.image_tag_version }}
            ${{ env.ALIBABA_CLOUD_REGISTRY }}/${{ env.ALIBABA_CLOUD_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.image_tag_timestamp }}
          platforms: linux/amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: âœ… æ˜¾ç¤ºé•œåƒä¿¡æ¯
        run: |
          echo "ğŸ‰ é•œåƒæ„å»ºå¹¶æ¨é€æˆåŠŸï¼"
          echo ""
          echo "ğŸ“¦ æ¨é€çš„é•œåƒæ ‡ç­¾ï¼š"
          echo "  ğŸ·ï¸ æœ€æ–°ç‰ˆæœ¬: ${{ env.ALIBABA_CLOUD_REGISTRY }}/${{ env.ALIBABA_CLOUD_NAMESPACE }}/${{ env.IMAGE_NAME }}:latest"
          echo "  ğŸ·ï¸ ç‰ˆæœ¬æ ‡ç­¾: ${{ env.ALIBABA_CLOUD_REGISTRY }}/${{ env.ALIBABA_CLOUD_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.image_tag_version }}"
          echo "  ğŸ·ï¸ æ—¶é—´æ ‡ç­¾: ${{ env.ALIBABA_CLOUD_REGISTRY }}/${{ env.ALIBABA_CLOUD_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.image_tag_timestamp }}"

      - name: ğŸ“‹ ç”Ÿæˆä½¿ç”¨æŒ‡å—
        run: |
          echo ""
          echo "ğŸš€ ================== é•œåƒä½¿ç”¨æŒ‡å— =================="
          echo ""
          echo "ğŸ” 1. ç™»å½•é˜¿é‡Œäº‘Docker Registryï¼š"
          echo "   docker login --username=é»„å¸…å•Š ${{ env.ALIBABA_CLOUD_REGISTRY }}"
          echo ""
          echo "ğŸ“¥ 2. æ‹‰å–é•œåƒï¼ˆé€‰æ‹©å…¶ä¸€ï¼‰ï¼š"
          echo "   # æ‹‰å–æœ€æ–°ç‰ˆæœ¬"
          echo "   docker pull ${{ env.ALIBABA_CLOUD_REGISTRY }}/${{ env.ALIBABA_CLOUD_NAMESPACE }}/${{ env.IMAGE_NAME }}:latest"
          echo ""
          echo "   # æ‹‰å–æŒ‡å®šç‰ˆæœ¬"
          echo "   docker pull ${{ env.ALIBABA_CLOUD_REGISTRY }}/${{ env.ALIBABA_CLOUD_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.image_tag_version }}"
          echo ""
          echo "   # æ‹‰å–æ—¶é—´æˆ³ç‰ˆæœ¬"
          echo "   docker pull ${{ env.ALIBABA_CLOUD_REGISTRY }}/${{ env.ALIBABA_CLOUD_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.image_tag_timestamp }}"
          echo ""
          echo "ğŸƒ 3. è¿è¡Œå®¹å™¨ï¼š"
          echo "   # åŸºæœ¬è¿è¡Œï¼ˆæ³¨æ„ï¼šå†…éƒ¨ç«¯å£æ˜¯9090ï¼‰"
          echo "   docker run -d --name bhuang-mcp-server \\"
          echo "     -p 8080:9090 \\"
          echo "     ${{ env.ALIBABA_CLOUD_REGISTRY }}/${{ env.ALIBABA_CLOUD_NAMESPACE }}/${{ env.IMAGE_NAME }}:latest"
          echo ""
          echo "   # å®Œæ•´é…ç½®è¿è¡Œ"
          echo "   docker run -d --name bhuang-mcp-server \\"
          echo "     -p 8080:9090 \\"
          echo "     -e JAVA_OPTS=\"-Xms512m -Xmx1024m\" \\"
          echo "     -e TZ=\"Asia/Shanghai\" \\"
          echo "     -e SPRING_PROFILES_ACTIVE=\"prod\" \\"
          echo "     --restart unless-stopped \\"
          echo "     ${{ env.ALIBABA_CLOUD_REGISTRY }}/${{ env.ALIBABA_CLOUD_NAMESPACE }}/${{ env.IMAGE_NAME }}:latest"
          echo ""
          echo "ğŸŒ 4. VPC ç½‘ç»œä¼˜åŒ–ï¼ˆå¦‚æœåœ¨é˜¿é‡Œäº‘ ECS ä¸Šéƒ¨ç½²ï¼‰ï¼š"
          echo "   # ä½¿ç”¨ VPC å†…ç½‘åœ°å€ï¼Œé€Ÿåº¦æ›´å¿«ï¼Œä¸æ¶ˆè€—å…¬ç½‘æµé‡"
          echo "   docker login --username=é»„å¸…å•Š crpi-wzl2k45d0lxbiagj-vpc.cn-shenzhen.personal.cr.aliyuncs.com"
          echo "   docker pull crpi-wzl2k45d0lxbiagj-vpc.cn-shenzhen.personal.cr.aliyuncs.com/${{ env.ALIBABA_CLOUD_NAMESPACE }}/${{ env.IMAGE_NAME }}:latest"
          echo ""
          echo "ğŸ” 5. å¥åº·æ£€æŸ¥å’Œç›‘æ§ï¼š"
          echo "   # æŸ¥çœ‹å®¹å™¨çŠ¶æ€"
          echo "   docker ps"
          echo "   # æŸ¥çœ‹åº”ç”¨æ—¥å¿—"
          echo "   docker logs -f bhuang-mcp-server"
          echo "   # å¥åº·æ£€æŸ¥"
          echo "   curl http://localhost:8080/actuator/health"
          echo "   # è®¿é—® MCP SSE ç«¯ç‚¹"
          echo "   curl http://localhost:8080/mcp/events"
          echo ""
          echo "=================================================="
          echo "âœ¨ æœ¬æ¬¡æ„å»ºä¿¡æ¯ï¼š"
          echo "   ğŸ“… æ„å»ºæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "   ğŸ“‹ åº”ç”¨ç‰ˆæœ¬: ${{ steps.version.outputs.version }}"
          echo "   ğŸ”— Gitæäº¤: ${{ steps.version.outputs.short_sha }}"
          echo "   ğŸ·ï¸ é•œåƒæ ‡ç­¾: ${{ steps.version.outputs.image_tag_version }}"
          echo "=================================================="

      - name: ğŸ“ åˆ›å»ºéƒ¨ç½²æ€»ç»“
        if: github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            const registry = '${{ env.ALIBABA_CLOUD_REGISTRY }}';
            const namespace = '${{ env.ALIBABA_CLOUD_NAMESPACE }}';
            const imageName = '${{ env.IMAGE_NAME }}';
            const versionTag = '${{ steps.version.outputs.image_tag_version }}';
            const timestampTag = '${{ steps.version.outputs.image_tag_timestamp }}';
            
            const summary = `
            ## ğŸš€ éƒ¨ç½²æˆåŠŸï¼
            
            ### ğŸ“¦ é•œåƒä¿¡æ¯
            - **æœ€æ–°ç‰ˆæœ¬**: \`${registry}/${namespace}/${imageName}:latest\`
            - **ç‰ˆæœ¬æ ‡ç­¾**: \`${registry}/${namespace}/${imageName}:${versionTag}\`
            - **æ—¶é—´æ ‡ç­¾**: \`${registry}/${namespace}/${imageName}:${timestampTag}\`
            
            ### ğŸƒ å¿«é€Ÿå¼€å§‹
            
            #### ğŸ” ç™»å½•é˜¿é‡Œäº‘ä»“åº“
            \`\`\`bash
            docker login --username=é»„å¸…å•Š ${registry}
            \`\`\`
            
            #### ğŸš€ æ‹‰å–å¹¶è¿è¡Œï¼ˆæ¨èï¼‰
            \`\`\`bash
            # æ‹‰å–æœ€æ–°é•œåƒ
            docker pull ${registry}/${namespace}/${imageName}:latest
            
            # è¿è¡Œå®¹å™¨ï¼ˆæ³¨æ„ç«¯å£æ˜ å°„ 8080:9090ï¼‰
            docker run -d --name bhuang-mcp-server \\
              -p 8080:9090 \\
              -e JAVA_OPTS="-Xms512m -Xmx1024m" \\
              -e TZ="Asia/Shanghai" \\
              --restart unless-stopped \\
              ${registry}/${namespace}/${imageName}:latest
            \`\`\`
            
            #### ğŸŒ VPC å†…ç½‘åŠ é€Ÿï¼ˆé˜¿é‡Œäº‘ ECSï¼‰
            \`\`\`bash
            # ä½¿ç”¨ VPC å†…ç½‘åœ°å€ï¼Œé€Ÿåº¦æ›´å¿«
            docker login --username=é»„å¸…å•Š crpi-wzl2k45d0lxbiagj-vpc.cn-shenzhen.personal.cr.aliyuncs.com
            docker pull crpi-wzl2k45d0lxbiagj-vpc.cn-shenzhen.personal.cr.aliyuncs.com/${namespace}/${imageName}:latest
            \`\`\`
            
            ### âœ¨ ç‰ˆæœ¬è¯¦æƒ…
            - **åº”ç”¨ç‰ˆæœ¬**: ${{ steps.version.outputs.version }}
            - **Gitæäº¤**: ${{ steps.version.outputs.short_sha }}
            - **æ„å»ºæ—¶é—´**: ${new Date().toISOString()}
            
            ### ğŸ“Š åº”ç”¨è®¿é—®
            - **è®¿é—®åœ°å€**: http://localhost:8080
            - **å¥åº·æ£€æŸ¥**: http://localhost:8080/actuator/health
            - **MCP SSEç«¯ç‚¹**: http://localhost:8080/mcp/events
            - **æŸ¥çœ‹æ—¥å¿—**: \`docker logs -f bhuang-mcp-server\`
            
            ### ğŸ› ï¸ ä¸€é”®éƒ¨ç½²è„šæœ¬
            \`\`\`bash
            curl -O https://raw.githubusercontent.com/${{ github.repository }}/master/deploy.sh
            chmod +x deploy.sh && ./deploy.sh
            \`\`\`
            `;
            
            await core.summary.addRaw(summary).write();

      - name: ğŸ¯ Docker Compose é…ç½®
        if: github.event_name == 'push'
        run: |
          echo "ğŸ“ ç”Ÿæˆ Docker Compose é…ç½®å»ºè®®ï¼š"
          echo ""
          cat << 'EOF'
          # docker-compose.yml ç¤ºä¾‹é…ç½®
          version: '3.8'
          services:
            bhuang-mcp-server:
              image: ${{ env.ALIBABA_CLOUD_REGISTRY }}/${{ env.ALIBABA_CLOUD_NAMESPACE }}/${{ env.IMAGE_NAME }}:latest
              container_name: bhuang-mcp-server
              ports:
                - "8080:9090"
              environment:
                - JAVA_OPTS=-Xms512m -Xmx1024m
                - TZ=Asia/Shanghai
                - SPRING_PROFILES_ACTIVE=prod
              restart: unless-stopped
              healthcheck:
                test: ["CMD", "curl", "-f", "http://localhost:9090/actuator/health"]
                interval: 30s
                timeout: 10s
                retries: 3
                start_period: 40s
          EOF 