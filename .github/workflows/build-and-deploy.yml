name: Build and Deploy to Alibaba Cloud

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: è¿è¡Œ Maven æ„å»º
        run: mvn clean package -DskipTests

      - name: è¿è¡Œæµ‹è¯•
        run: mvn test

      - name: éªŒè¯æ„å»ºäº§ç‰©
        run: ls -la target/

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½•é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ALIBABA_CLOUD_REGISTRY }}
          username: ${{ secrets.ALIBABA_CLOUD_USERNAME }}
          password: ${{ secrets.ALIBABA_CLOUD_PASSWORD }}

      - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          SHORT_SHA=$(git rev-parse --short HEAD)
          IMAGE_TAG=${VERSION}-${SHORT_SHA}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT

      - name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ secrets.ALIBABA_CLOUD_REGISTRY }}/${{ secrets.ALIBABA_CLOUD_NAMESPACE }}/bhuang-mcp-csdn-server-sse:latest
            ${{ secrets.ALIBABA_CLOUD_REGISTRY }}/${{ secrets.ALIBABA_CLOUD_NAMESPACE }}/bhuang-mcp-csdn-server-sse:${{ steps.version.outputs.image_tag }}
          platforms: linux/amd64

      - name: æ˜¾ç¤ºé•œåƒä¿¡æ¯
        run: |
          echo "âœ… é•œåƒæ„å»ºå¹¶æ¨é€æˆåŠŸï¼"
          echo "ğŸ“¦ é•œåƒæ ‡ç­¾ï¼š"
          echo "   - ${{ secrets.ALIBABA_CLOUD_REGISTRY }}/${{ secrets.ALIBABA_CLOUD_NAMESPACE }}/bhuang-mcp-csdn-server-sse:latest"
          echo "   - ${{ secrets.ALIBABA_CLOUD_REGISTRY }}/${{ secrets.ALIBABA_CLOUD_NAMESPACE }}/bhuang-mcp-csdn-server-sse:${{ steps.version.outputs.image_tag }}"

      - name: ğŸ“‹ ä½¿ç”¨è¯´æ˜
        run: |
          echo ""
          echo "ğŸš€ ================== é•œåƒä½¿ç”¨æŒ‡å— =================="
          echo ""
          echo "ğŸ“ 1. ç™»å½•é˜¿é‡Œäº‘Docker Registryï¼š"
          echo "   docker login --username=é»„å¸…å•Š ${{ secrets.ALIBABA_CLOUD_REGISTRY }}"
          echo ""
          echo "ğŸ“¦ 2. æ‹‰å–é•œåƒï¼ˆé€‰æ‹©å…¶ä¸€ï¼‰ï¼š"
          echo "   # æ‹‰å–æœ€æ–°ç‰ˆæœ¬"
          echo "   docker pull ${{ secrets.ALIBABA_CLOUD_REGISTRY }}/${{ secrets.ALIBABA_CLOUD_NAMESPACE }}/bhuang-mcp-csdn-server-sse:latest"
          echo ""
          echo "   # æ‹‰å–æŒ‡å®šç‰ˆæœ¬"
          echo "   docker pull ${{ secrets.ALIBABA_CLOUD_REGISTRY }}/${{ secrets.ALIBABA_CLOUD_NAMESPACE }}/bhuang-mcp-csdn-server-sse:${{ steps.version.outputs.image_tag }}"
          echo ""
          echo "ğŸƒ 3. è¿è¡Œå®¹å™¨ï¼š"
          echo "   # åŸºæœ¬è¿è¡Œ"
          echo "   docker run -d --name bhuang-mcp-server -p 8080:8080 \\"
          echo "     ${{ secrets.ALIBABA_CLOUD_REGISTRY }}/${{ secrets.ALIBABA_CLOUD_NAMESPACE }}/bhuang-mcp-csdn-server-sse:latest"
          echo ""
          echo "   # å¸¦ç¯å¢ƒå˜é‡è¿è¡Œ"
          echo "   docker run -d --name bhuang-mcp-server -p 8080:8080 \\"
          echo "     -e JAVA_OPTS=\"-Xms512m -Xmx1024m\" \\"
          echo "     -e TZ=\"Asia/Shanghai\" \\"
          echo "     --restart unless-stopped \\"
          echo "     ${{ secrets.ALIBABA_CLOUD_REGISTRY }}/${{ secrets.ALIBABA_CLOUD_NAMESPACE }}/bhuang-mcp-csdn-server-sse:latest"
          echo ""
          echo "ğŸ³ 4. ä½¿ç”¨ Docker Composeï¼š"
          echo "   # ä¸‹è½½ docker-compose.yml æ–‡ä»¶"
          echo "   curl -O https://raw.githubusercontent.com/${{ github.repository }}/master/docker-compose.yml"
          echo "   # å¯åŠ¨æœåŠ¡"
          echo "   docker-compose up -d"
          echo ""
          echo "ğŸ“Š 5. ç›‘æ§å’Œç»´æŠ¤ï¼š"
          echo "   # æŸ¥çœ‹è¿è¡ŒçŠ¶æ€"
          echo "   docker ps"
          echo "   # æŸ¥çœ‹æ—¥å¿—"
          echo "   docker logs -f bhuang-mcp-server"
          echo "   # å¥åº·æ£€æŸ¥"
          echo "   curl http://localhost:8080/actuator/health"
          echo ""
          echo "ğŸ› ï¸ 6. ä¸€é”®éƒ¨ç½²è„šæœ¬ï¼š"
          echo "   # ä¸‹è½½éƒ¨ç½²è„šæœ¬"
          echo "   curl -O https://raw.githubusercontent.com/${{ github.repository }}/master/deploy.sh"
          echo "   chmod +x deploy.sh"
          echo "   # æ‰§è¡Œéƒ¨ç½²"
          echo "   ./deploy.sh"
          echo ""
          echo "=================================================="
          echo "âœ¨ ç‰ˆæœ¬ä¿¡æ¯ï¼š"
          echo "   åº”ç”¨ç‰ˆæœ¬: ${{ steps.version.outputs.version }}"
          echo "   Gitæäº¤: ${{ steps.version.outputs.short_sha }}"
          echo "   é•œåƒæ ‡ç­¾: ${{ steps.version.outputs.image_tag }}"
          echo "   æ„å»ºæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "=================================================="

      - name: ğŸ“ åˆ›å»ºéƒ¨ç½²æ€»ç»“
        if: github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `
            ## ğŸš€ éƒ¨ç½²æˆåŠŸï¼
            
            ### ğŸ“¦ é•œåƒä¿¡æ¯
            - **æœ€æ–°ç‰ˆæœ¬**: \`${{ secrets.ALIBABA_CLOUD_REGISTRY }}/${{ secrets.ALIBABA_CLOUD_NAMESPACE }}/bhuang-mcp-csdn-server-sse:latest\`
            - **æŒ‡å®šç‰ˆæœ¬**: \`${{ secrets.ALIBABA_CLOUD_REGISTRY }}/${{ secrets.ALIBABA_CLOUD_NAMESPACE }}/bhuang-mcp-csdn-server-sse:${{ steps.version.outputs.image_tag }}\`
            
            ### ğŸƒ å¿«é€Ÿå¼€å§‹
            
            #### æ–¹å¼1: ç›´æ¥è¿è¡Œ
            \`\`\`bash
            # ç™»å½•
            docker login --username=é»„å¸…å•Š ${{ secrets.ALIBABA_CLOUD_REGISTRY }}
            
            # æ‹‰å–å¹¶è¿è¡Œ
            docker pull ${{ secrets.ALIBABA_CLOUD_REGISTRY }}/${{ secrets.ALIBABA_CLOUD_NAMESPACE }}/bhuang-mcp-csdn-server-sse:latest
            docker run -d --name bhuang-mcp-server -p 8080:8080 \\
              -e JAVA_OPTS="-Xms512m -Xmx1024m" \\
              --restart unless-stopped \\
              ${{ secrets.ALIBABA_CLOUD_REGISTRY }}/${{ secrets.ALIBABA_CLOUD_NAMESPACE }}/bhuang-mcp-csdn-server-sse:latest
            \`\`\`
            
            #### æ–¹å¼2: Docker Compose
            \`\`\`bash
            curl -O https://raw.githubusercontent.com/${{ github.repository }}/master/docker-compose.yml
            docker-compose up -d
            \`\`\`
            
            #### æ–¹å¼3: ä¸€é”®éƒ¨ç½²
            \`\`\`bash
            curl -O https://raw.githubusercontent.com/${{ github.repository }}/master/deploy.sh
            chmod +x deploy.sh && ./deploy.sh
            \`\`\`
            
            ### âœ¨ ç‰ˆæœ¬è¯¦æƒ…
            - **åº”ç”¨ç‰ˆæœ¬**: ${{ steps.version.outputs.version }}
            - **Gitæäº¤**: ${{ steps.version.outputs.short_sha }}
            - **æ„å»ºæ—¶é—´**: ${new Date().toISOString()}
            
            ### ğŸ“Š åº”ç”¨è®¿é—®
            - **è®¿é—®åœ°å€**: http://localhost:8080
            - **å¥åº·æ£€æŸ¥**: http://localhost:8080/actuator/health
            - **æŸ¥çœ‹æ—¥å¿—**: \`docker logs -f bhuang-mcp-server\`
            `;
            
            await core.summary.addRaw(summary).write(); 