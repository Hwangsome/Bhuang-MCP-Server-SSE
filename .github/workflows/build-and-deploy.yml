name: ğŸš€ æ„å»ºå¹¶éƒ¨ç½²åˆ°é˜¿é‡Œäº‘

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - master

env:
  # é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡é…ç½®
  ALIBABA_CLOUD_REGISTRY: crpi-wzl2k45d0lxbiagj.cn-shenzhen.personal.cr.aliyuncs.com
  NAMESPACE: bhuang-repo
  IMAGE_NAME: bhuang-mcp-server-sse

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: â˜• è®¾ç½® JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: ğŸ“¦ Maven ç¼“å­˜
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: ğŸ”§ Maven ç¼–è¯‘å’Œæµ‹è¯•
      run: |
        mvn clean compile test -q
        echo "âœ… Maven ç¼–è¯‘å’Œæµ‹è¯•å®Œæˆ"

    - name: ğŸ“¦ æ‰“åŒ…åº”ç”¨
      run: |
        mvn package -DskipTests -q
        echo "âœ… åº”ç”¨æ‰“åŒ…å®Œæˆ"

    - name: ğŸ·ï¸ ç”Ÿæˆé•œåƒæ ‡ç­¾
      id: meta
      run: |
        # åŸºç¡€é•œåƒå
        IMAGE_BASE="${ALIBABA_CLOUD_REGISTRY}/${NAMESPACE}/${IMAGE_NAME}"
        
        # æ ¹æ®è§¦å‘äº‹ä»¶ç”Ÿæˆæ ‡ç­¾
        if [[ $GITHUB_REF == refs/tags/v* ]]; then
          # æ ‡ç­¾æ¨é€ï¼šä½¿ç”¨ç‰ˆæœ¬å·
          VERSION=${GITHUB_REF#refs/tags/v}
          TAGS="${IMAGE_BASE}:${VERSION},${IMAGE_BASE}:latest"
          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
        elif [[ $GITHUB_REF == refs/heads/main ]] || [[ $GITHUB_REF == refs/heads/master ]]; then
          # ä¸»åˆ†æ”¯æ¨é€ï¼šä½¿ç”¨latestå’Œæäº¤SHA
          SHORT_SHA=${GITHUB_SHA::8}
          TAGS="${IMAGE_BASE}:latest,${IMAGE_BASE}:${SHORT_SHA}"
          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "version=latest" >> $GITHUB_OUTPUT
        else
          # å…¶ä»–åˆ†æ”¯ï¼šä½¿ç”¨åˆ†æ”¯åå’Œæäº¤SHA
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          SHORT_SHA=${GITHUB_SHA::8}
          SAFE_BRANCH=$(echo ${BRANCH_NAME} | sed 's/[^a-zA-Z0-9.-]/-/g')
          TAGS="${IMAGE_BASE}:${SAFE_BRANCH}-${SHORT_SHA}"
          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "version=${SAFE_BRANCH}-${SHORT_SHA}" >> $GITHUB_OUTPUT
        fi
        
        echo "ğŸ·ï¸ ç”Ÿæˆçš„é•œåƒæ ‡ç­¾: $(echo $TAGS | tr ',' '\n')"

    - name: ğŸ” ç™»å½•é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡
      uses: docker/login-action@v3
      with:
        registry: ${{ env.ALIBABA_CLOUD_REGISTRY }}
        username: ${{ secrets.ALIBABA_CLOUD_USERNAME }}
        password: ${{ secrets.ALIBABA_CLOUD_PASSWORD }}

    - name: ğŸ³ è®¾ç½® Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ”¨ æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        platforms: linux/amd64,linux/arm64
        labels: |
          org.opencontainers.image.title=Bhuang MCP Server SSE
          org.opencontainers.image.description=Weather Service MCP Server with SSE Transport
          org.opencontainers.image.version=${{ steps.meta.outputs.version }}
          org.opencontainers.image.source=https://github.com/${{ github.repository }}
          org.opencontainers.image.revision=${{ github.sha }}
          org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: ğŸ“‹ éƒ¨ç½²ä¿¡æ¯
      run: |
        echo "## ğŸ‰ éƒ¨ç½²æˆåŠŸ!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“¦ é•œåƒä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **ä»“åº“**: \`${{ env.ALIBABA_CLOUD_REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **æ ‡ç­¾**: \`${{ steps.meta.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **æ¶æ„**: \`linux/amd64, linux/arm64\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸš€ éƒ¨ç½²å‘½ä»¤" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "# æ‹‰å–é•œåƒ" >> $GITHUB_STEP_SUMMARY
        echo "docker pull ${{ env.ALIBABA_CLOUD_REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# è¿è¡Œå®¹å™¨" >> $GITHUB_STEP_SUMMARY
        echo "docker run -d --name bhuang-mcp-server \\" >> $GITHUB_STEP_SUMMARY
        echo "  -p 8080:9090 \\" >> $GITHUB_STEP_SUMMARY
        echo "  -e JAVA_OPTS=\"-Xms512m -Xmx1024m -XX:+UseG1GC\" \\" >> $GITHUB_STEP_SUMMARY
        echo "  -e TZ=\"Asia/Shanghai\" \\" >> $GITHUB_STEP_SUMMARY
        echo "  ${{ env.ALIBABA_CLOUD_REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ”— æœåŠ¡ç«¯ç‚¹" >> $GITHUB_STEP_SUMMARY
        echo "- **å¥åº·æ£€æŸ¥**: \`http://localhost:8080/actuator/health\`" >> $GITHUB_STEP_SUMMARY
        echo "- **MCP SSE**: \`http://localhost:8080/sse\`" >> $GITHUB_STEP_SUMMARY
        echo "- **MCP æ¶ˆæ¯**: \`http://localhost:8080/mcp/messages\`" >> $GITHUB_STEP_SUMMARY

  # ä»…åœ¨ä¸»åˆ†æ”¯æˆåŠŸéƒ¨ç½²åæ‰§è¡Œ
  notify-success:
    needs: build-and-deploy
    runs-on: ubuntu-latest
    if: success() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: ğŸ‰ éƒ¨ç½²æˆåŠŸé€šçŸ¥
      run: |
        echo "ğŸš€ Bhuang MCP Server SSE å·²æˆåŠŸéƒ¨ç½²åˆ°é˜¿é‡Œäº‘!"
        echo "ğŸ“¦ é•œåƒåœ°å€: ${{ env.ALIBABA_CLOUD_REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:latest"
        echo "ğŸ”— å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ‹‰å–å’Œè¿è¡Œ:"
        echo "   docker pull ${{ env.ALIBABA_CLOUD_REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:latest" 